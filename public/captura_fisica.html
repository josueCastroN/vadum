<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>VADUM · Captura Física</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./assets/css/estilos.css">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <nav class="nav">
      <a class="nav__logo" href="./index.html">
        <img src="./assets/img/VADUM-negro.png" alt="VADUM">
        <span class="nav__titulo">Sistema de Incentivos</span>
      </a>
      <div class="nav__links">
        <a class="nav__link nav__link--activo" id="nav-fisica" href="./captura_fisica.html">Física</a>
        <a class="nav__link" id="nav-mensual" href="./evaluacion_mensual.html">Mensual</a>
        <a class="nav__link" id="nav-encuesta" href="./encuesta.html">Encuesta</a>
        <a class="nav__link" id="nav-incentivo" href="./incentivo.html">Incentivo</a>
      </div>
    </nav>
  </header>

  <main class="contenedor">
    <section class="tarjeta">
      <h1 class="titulo">Captura Física (Grupal)</h1>
      <div class="fila fila--3">
        <div>
          <label class="label">Fecha</label>
          <input class="input" id="fecha" type="date">
        </div>
        <div>
          <label class="label">Trimestre</label>
          <input class="input" id="tri" type="number" min="1" max="4" value="3">
        </div>
        <div>
          <label class="label">Sede</label>
          <input class="input" id="sede" placeholder="Campo / Gimnasio">
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:10px;">
        <button class="btn" id="btnSesion">Crear sesión</button>
        <span id="infoSesion" class="chip">Sin sesión</span>
      </div>
    </section>

    <section class="tarjeta" style="margin-top:16px;">
      <h2 class="subtitulo">Tabla de capturas</h2>
      <table class="tabla" id="tabla">
        <thead>
          <tr>
            <th>No.Emp</th><th>Edad</th><th>12min (m)</th><th>100m (s)</th>
            <th>Abd</th><th>Lag</th><th>Bar</th><th>Bur</th><th>Guardar</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
      <div style="margin-top:12px;">
        <button class="btn btn--fantasma" id="agregarFila">+ Agregar fila</button>
      </div>
    </section>

    <section class="tarjeta" style="margin-top:16px;">
      <h2 class="subtitulo">Firma del empleado (opcional)</h2>
      <canvas id="lienzo" width="320" height="120" style="background:#fff; border:1px dashed #777; border-radius: 8px;"></canvas>
      <div style="margin-top:10px; display:flex; gap:10px;">
        <button class="btn" id="btnFirma">Guardar Firma</button>
        <button class="btn btn--borde" id="btnCerrar">Cerrar sesión</button>
      </div>
    </section>
  </main>

  <footer class="footer">© VADUM · Automatización de Incentivos ·</footer>
  <script src="./assets/js/ui.js"></script>
<script src="./assets/js/auth.js"></script>
  <script>
    // ========= Lógica  =========
    const tbody = document.getElementById('tb');
    const infoSesion = document.getElementById('infoSesion');
    const inputFecha = document.getElementById('fecha');
    inputFecha.value = new Date().toISOString().slice(0,10);

    let sesionId = null;

    function nuevaFila(noEmp='', edad=0, m12=0, s100=0, ab=0, lg=0, br=0, bu=0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="input" value="${noEmp}"></td>
        <td><input class="input" type="number" value="${edad}"></td>
        <td><input class="input" type="number" value="${m12}"></td>
        <td><input class="input" type="number" step="0.01" value="${s100}"></td>
        <td><input class="input" type="number" value="${ab}"></td>
        <td><input class="input" type="number" value="${lg}"></td>
        <td><input class="input" type="number" value="${br}"></td>
        <td><input class="input" type="number" value="${bu}"></td>
        <td><button class="btn guardar">Guardar</button></td>
      `;
      tbody.appendChild(tr);

      tr.querySelector('.guardar').onclick = async () => {
        if (!sesionId) return mostrarToast('Primero crea la sesión');
        const c = tr.querySelectorAll('input');
        const payload = {
          sesion_id: sesionId,
          no_emp:  c[0].value.trim(),
          edad:    +c[1].value,
          v_12min_m:+c[2].value,
          v_100m_s:+c[3].value,
          v_abdom: +c[4].value,
          v_lagart:+c[5].value,
          v_barras:+c[6].value,
          v_burpees:+c[7].value,
        };
        const r = await fetch('../api/index.php?ruta=fisicas/registro', {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
        }).then(r=>r.json());
        mostrarToast('Calificación física: ' + r.cal_fisica);
      };
    }
    document.getElementById('agregarFila').onclick = () => nuevaFila();

    document.getElementById('btnSesion').onclick = async () => {
      const r = await fetch('../api/index.php?ruta=fisicas/sesion', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          fecha: inputFecha.value,
          trimestre: +document.getElementById('tri').value || 1,
          evaluador_id:'sup-001',
          sede: document.getElementById('sede').value || 'Campo'
        })
      }).then(r=>r.json());
      sesionId = r.sesion_id;
      infoSesion.textContent = 'Sesión: ' + sesionId;
      mostrarToast('Sesión creada');
    };

    // Firma
    const canvas = document.getElementById('lienzo');
    const ctx = canvas.getContext('2d');
    let pintando = false;
    canvas.addEventListener('mousedown', ()=> pintando = true);
    canvas.addEventListener('mouseup', ()=> pintando = false);
    canvas.addEventListener('mousemove', (e)=>{
      if(!pintando) return;
      const r = canvas.getBoundingClientRect();
      ctx.fillStyle = '#000';
      ctx.beginPath();
      ctx.arc(e.clientX - r.left, e.clientY - r.top, 1.2, 0, Math.PI*2);
      ctx.fill();
    });

    document.getElementById('btnFirma').onclick = async ()=>{
      if (!sesionId) return mostrarToast('Crea una sesión primero');
      const dataURL = canvas.toDataURL('image/png');
      const r = await fetch('../api/index.php?ruta=firmas/guardar', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ tipo:'fisica_empleado', sesion_id: sesionId, no_emp:'950001', firma_base64: dataURL })
      }).then(r=>r.json());
      mostrarToast('Firma guardada');
      console.log('URL firma:', r.url);
    };

    document.getElementById('btnCerrar').onclick = async ()=>{
      if (!sesionId) return mostrarToast('No hay sesión');
      await fetch('../api/index.php?ruta=fisicas/cerrar', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ sesion_id: sesionId })
      });
      mostrarToast('Sesión cerrada');
    };
  </script>
</body>
</html>
