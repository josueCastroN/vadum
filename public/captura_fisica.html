<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>VADUM ¬∑ Captura F√≠sica</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="./assets/css/estilos.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>
    <div class="app-shell">
        <header class="app-header">
            <nav class="nav-sup app-header__inner d-flex justify-content-between align-items-center p-2">
                <a class="nav-sup__logo text-decoration-none d-flex align-items-center" href="./index.html">
                    <img src="./assets/img/VADUM-negro.png" alt="VADUM" style="height:30px;" class="me-2">
                    <span class="nav-sup__titulo h6 m-0 text-dark">Sistema Automatizado de Incentivos ¬∑ VADUM</span>
                </a>
                
                <div class="dropdown" id="perfilMenu">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle d-flex align-items-center" 
                            type="button" id="btnPerfil" data-bs-toggle="dropdown" aria-expanded="false">
                        <span id="usuarioActual" class="me-2">‚Ä¶</span>
                        <span class="perfil__avatar rounded-circle bg-warning text-dark px-2">üë§</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" id="perfilDropdown" aria-labelledby="btnPerfil">
                        <li class="dropdown-item-text">
                            <div class="perfil__info">
                                <div class="perfil__nombre fw-bold" id="perfilNombre">Usuario</div>
                                <div class="perfil__rol text-muted small" id="perfilRol">Rol</div>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="irPerfil">Mi perfil</a></li>
                        <li><button class="dropdown-item text-danger" id="btnSalir">Cerrar sesi√≥n</button></li>
                    </ul>
                </div>
            </nav>
        </header>

        <div class="app-body">
            <aside class="app-sidebar" aria-label="Men√∫ principal">
                <nav class="sidebar-nav">
                    <a class="sidebar-link" id="nav-inicio" href="./index.html" data-roles="admin,supervisor,vigilante,cliente">Inicio</a>
                    <a class="sidebar-link" id="nav-empleados" href="./empleados.html" data-roles="admin,supervisor">Empleados</a>
                    <a class="sidebar-link sidebar-link--activo" id="nav-fisica" href="./captura_fisica.html" data-roles="admin,supervisor">F√≠sica</a>
                    <a class="sidebar-link" id="nav-mensual" href="./evaluacion_mensual.html" data-roles="admin,supervisor">Mensual</a>
                    <a class="sidebar-link" id="nav-encuesta" href="./encuesta.html" data-roles="admin,cliente,supervisor">Encuesta</a>
                    <a class="sidebar-link" id="nav-incentivo" href="./incentivo.html" data-roles="admin,supervisor,vigilante">Incentivo</a>
                    <a class="sidebar-link" id="nav-catalogos" href="./catalogos.html" data-roles="admin,supervisor">Cat√°logos</a>
                </nav>
            </aside>

            <main class="app-content p-3 p-md-4">
                <section class="card p-4">
                    <h1 class="h4 fw-bold mb-4">Captura de Evaluaci√≥n F√≠sica (Checklist)</h1>
                    
                    <div class="row g-4">
                        <div class="col-lg-6">
                            <h2 class="h5 fw-semibold mb-3">Informaci√≥n de la Captura</h2>
                            <div class="row g-3">
                                <div class="col-sm-6">
                                    <label class="form-label" for="no_emp">No. Empleado</label>
                                    <input class="form-control" id="no_emp" placeholder="950001" value="950001">
                                </div>
                                <div class="col-sm-6">
                                    <label class="form-label" for="punto_id">Punto ID</label>
                                    <input class="form-control" id="punto_id" placeholder="PUNTO-01" value="PUNTO-01">
                                </div>
                                <div class="col-12">
                                    <label class="form-label" for="supervisor_id">Evaluador (Supervisor ID)</label>
                                    <input class="form-control" id="supervisor_id" placeholder="SUP-001" value="SUP-001">
                                </div>
                                <div class="col-12">
                                    <label class="form-label" for="observaciones">Observaciones</label>
                                    <textarea class="form-control" id="observaciones" rows="2"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <h2 class="h5 fw-semibold mb-3">Evidencia Fotogr√°fica</h2>
                            
                            <div class="mb-3">
                                <label for="fotoInput" class="form-label">Tomar / Seleccionar Foto</label>
                                <input class="form-control" type="file" id="fotoInput" accept="image/*" capture="camera" required>
                                <div class="form-text">La imagen ser√° usada como evidencia de la condici√≥n f√≠sica.</div>
                            </div>
                            
                            <div class="border rounded p-2 text-center bg-light">
                                <img id="fotoPreview" src="./assets/img/placeholder-foto.png" alt="Previsualizaci√≥n de Foto" class="img-fluid rounded" style="max-height: 200px; object-fit: cover;">
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">

                    <h2 class="h5 fw-bold mb-3">M√©trica de Evaluaci√≥n (Puntaje de 0 a 10)</h2>
                    <div class="row g-3">
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label" for="item1">Uniforme (1-10)</label>
                            <input class="form-control" id="item1" type="number" min="1" max="10" value="10">
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label" for="item2">Peinado / Rasurado (1-10)</label>
                            <input class="form-control" id="item2" type="number" min="1" max="10" value="9">
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label" for="item3">Limpieza de Caseta/Punto (1-10)</label>
                            <input class="form-control" id="item3" type="number" min="1" max="10" value="8">
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label" for="item4">Posici√≥n / Atenci√≥n (1-10)</label>
                            <input class="form-control" id="item4" type="number" min="1" max="10" value="10">
                        </div>
                    </div>

                    <div class="mt-5 text-center">
                        <button class="btn btn-primary btn-lg" id="guardar">
                            <i class="fas fa-save me-2"></i> Guardar Captura
                        </button>
                    </div>

                </section>
            </main>
        </div>

        <footer class="footer text-center p-3 border-top">¬© VADUM ¬∑ Automatizaci√≥n de Incentivos</footer>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./assets/js/ui.js"></script>
    <script src="./assets/js/auth.js"></script>
    <script>
    const mostrarToast = window.VADUM_UI?.mostrarToast || console.log;

    // Funci√≥n auxiliar para enviar datos por POST (misma que en evaluaci√≥n_mensual.html)
    async function postData(url, data){
        const r = await fetch(url, { 
            method:'POST', 
            headers:{'Content-Type':'application/json'}, 
            credentials:'include',
            body: JSON.stringify(data) 
        });
        if (!r.ok) throw new Error(`Error ${r.status} al postear datos: ${r.statusText}`);
        return r.json();
    }
    
    // --- L√≥gica de Previsualizaci√≥n de Foto ---
    document.getElementById('fotoInput').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('fotoPreview').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    // --- L√≥gica de Guardado (incluyendo la foto como Base64) ---
    document.getElementById('guardar').onclick = async () => {
        const fotoInput = document.getElementById('fotoInput');
        const file = fotoInput.files[0];
        
        if (!file) {
            mostrarToast('Debe tomar o seleccionar una foto de evidencia.','error');
            return;
        }

        const datos = {
            no_emp: document.getElementById('no_emp').value.trim(),
            punto_id: document.getElementById('punto_id').value.trim(),
            supervisor_id: document.getElementById('supervisor_id').value.trim(),
            observaciones: document.getElementById('observaciones').value.trim(),
            uniforme: +document.getElementById('item1').value,
            peinado: +document.getElementById('item2').value,
            limpieza: +document.getElementById('item3').value,
            posicion: +document.getElementById('item4').value,
            foto_base64: '' // Se llenar√° con la lectura del archivo
        };

        if (!datos.no_emp || !datos.punto_id || !datos.supervisor_id) {
            mostrarToast('Rellena los campos obligatorios (No. Empleado, Punto ID, Evaluador ID).','error');
            return;
        }

        // Funci√≥n para leer el archivo como Base64
        const readFileAsBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        try {
            mostrarToast('Convirtiendo imagen y enviando datos...', 'info');
            
            // Convertir la imagen a Base64
            datos.foto_base64 = await readFileAsBase64(file);
            
            // Enviar los datos
            const r = await postData('../api/index.php?ruta=fisica/guardar', datos);
            
            mostrarToast(`Captura Guardada. Promedio: ${r.promedio_0_10} / 10`,'ok');
            
            // Opcional: Limpiar el formulario despu√©s de guardar
            // document.getElementById('observaciones').value = '';
            // document.getElementById('fotoInput').value = ''; 
            // document.getElementById('fotoPreview').src = './assets/img/placeholder-foto.png';

        } catch (e) {
            console.error(e);
            mostrarToast('Error al guardar la captura. Verifica la conexi√≥n con la API.','error');
        }
    };
    </script>
</body>
</html>