<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>VADUM ¬∑ Cat√°logos</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="./assets/css/estilos.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>
    <div class="app-shell">
        <header class="app-header">
            <nav class="nav-sup app-header__inner d-flex justify-content-between align-items-center p-2">
                <a class="nav-sup__logo text-decoration-none d-flex align-items-center" href="./index.html">
                    <img src="./assets/img/VADUM-negro.png" alt="VADUM" style="height:30px;" class="me-2">
                    <span class="nav-sup__titulo h6 m-0 text-dark">Sistema Automatizado de Incentivos ¬∑ VADUM</span>
                </a>
                
                <div class="dropdown" id="perfilMenu">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle d-flex align-items-center" 
                            type="button" id="btnPerfil" data-bs-toggle="dropdown" aria-expanded="false">
                        <span id="usuarioActual">‚Ä¶</span>
                        <span class="perfil__avatar">üë§</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" id="perfilDropdown" aria-labelledby="btnPerfil">
                        <li class="dropdown-item-text">
                            <div class="perfil__info">
                                <div class="perfil__nombre" id="perfilNombre">Usuario</div>
                                <div class="perfil__rol" id="perfilRol">Rol</div>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="irPerfil">Mi perfil</a></li>
                        <li><button class="dropdown-item text-danger" id="btnSalir">Cerrar sesi√≥n</button></li>
                    </ul>
                </div>
            </nav>
        </header>

        <div class="app-body">
            <aside class="app-sidebar" aria-label="Men√∫ principal">
                <nav class="sidebar-nav">
                    <a class="sidebar-link" id="nav-inicio" href="./index.html" data-roles="admin,supervisor,vigilante,cliente">Inicio</a>
                    <a class="sidebar-link" id="nav-empleados" href="./empleados.html" data-roles="admin,supervisor">Empleados</a>
                    <a class="sidebar-link" id="nav-fisica" href="./captura_fisica.html" data-roles="admin,supervisor">F√≠sica</a>
                    <a class="sidebar-link" id="nav-mensual" href="./evaluacion_mensual.html" data-roles="admin,supervisor">Mensual</a>
                    <a class="sidebar-link" id="nav-encuesta" href="./encuesta.html" data-roles="admin,cliente,supervisor">Encuesta</a>
                    <a class="sidebar-link" id="nav-incentivo" href="./incentivo.html" data-roles="admin,supervisor,vigilante">Incentivo</a>
                    <a class="sidebar-link sidebar-link--activo" id="nav-catalogos" href="./catalogos.html" data-roles="admin,supervisor">Cat√°logos</a>
                </nav>
            </aside>

            <main class="app-content p-3 p-md-4">
                <section class="card p-4">
                    <h1 class="h4 fw-bold mb-4">Mantenimiento de Cat√°logos</h1>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label for="selectCatalogo" class="form-label">Seleccionar Cat√°logo</label>
                            <select class="form-select" id="selectCatalogo">
                                <option value="puntos">Puntos / Edificios</option>
                                <option value="roles">Roles</option>
                                <option value="horarios">Horarios</option>
                                </select>
                        </div>
                        <div class="col-md-8 d-flex align-items-end justify-content-end">
                            <button class="btn btn-success" id="btnNuevoRegistro">
                                <i class="fas fa-plus-circle me-1"></i> Nuevo Registro
                            </button>
                        </div>
                    </div>

                    <h2 class="h5 mb-3" id="tituloTabla">Cat√°logo de Puntos / Edificios</h2>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead class="table-dark" id="tablaEncabezado">
                                <tr><th>ID</th><th>Nombre</th><th>Acciones</th></tr>
                            </thead>
                            <tbody id="tablaCuerpo">
                                <tr><td colspan="3" class="text-center text-muted">Seleccione un cat√°logo...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <nav aria-label="Navegaci√≥n de registros" class="mt-3">
                        <ul class="pagination justify-content-center" id="paginador">
                            </ul>
                    </nav>
                    <small class="text-muted mt-2 d-block text-center" id="infoPaginacion">Mostrando 0 de 0 registros</small>

                </section>
            </main>
        </div>

        <footer class="footer text-center p-3 border-top">¬© VADUM ¬∑ Automatizaci√≥n de Incentivos</footer>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./assets/js/ui.js"></script>
    <script src="./assets/js/auth.js"></script>
    <script>
    const mostrarToast = window.VADUM_UI?.mostrarToast || console.log;
    
    // --- Configuraci√≥n de Paginaci√≥n ---
    const LIMITE_REGISTROS = 20;
    let paginaActual = 1;
    
    // --- Mapa de Cat√°logos para Encabezados de Tabla ---
    const catalogosConfig = {
        'puntos': {
            titulo: 'Puntos / Edificios',
            encabezados: ['ID', 'Nombre del Punto', 'Direcci√≥n', 'Cliente ID', 'Acciones'],
            apiEndpoint: 'puntos/lista',
            keyId: 'punto_id'
        },
        'roles': {
            titulo: 'Roles de Usuario',
            encabezados: ['ID', 'Nombre del Rol', 'Descripci√≥n', 'Acciones'],
            apiEndpoint: 'roles/lista',
            keyId: 'rol_id'
        },
        'horarios': {
            titulo: 'Horarios',
            encabezados: ['ID', 'Descripci√≥n', 'Hora Inicio', 'Hora Fin', 'Acciones'],
            apiEndpoint: 'horarios/lista',
            keyId: 'horario_id'
        }
    };
    let catalogoActual = 'puntos';

    // Funci√≥n reutilizable para generar el paginador (Misma que en empleados.html)
    function generarPaginador(totalPaginas, paginaActual) {
        const paginador = document.getElementById('paginador');
        paginador.innerHTML = ''; 
        
        const crearBoton = (texto, numero, activo, deshabilitado) => {
            const li = document.createElement('li');
            li.classList.add('page-item');
            if (activo) li.classList.add('active');
            if (deshabilitado) li.classList.add('disabled');

            const a = document.createElement('a');
            a.classList.add('page-link');
            a.href = '#';
            a.textContent = texto;
            a.onclick = (e) => {
                e.preventDefault();
                if (!deshabilitado && numero !== paginaActual) {
                    cargarDatos(numero);
                }
            };
            li.appendChild(a);
            return li;
        };

        paginador.appendChild(crearBoton('Anterior', paginaActual - 1, false, paginaActual === 1));

        let inicio = Math.max(1, paginaActual - 2);
        let fin = Math.min(totalPaginas, paginaActual + 2);
        
        // ... (l√≥gica de botones num√©ricos igual que en empleados.html)
        if (totalPaginas > 5) {
            if (paginaActual <= 3) fin = 5;
            else if (paginaActual >= totalPaginas - 2) inicio = totalPaginas - 4;
            
            if (inicio > 1) {
                paginador.appendChild(crearBoton('1', 1, false, false));
                if (inicio > 2) {
                    const li = document.createElement('li');
                    li.classList.add('page-item', 'disabled');
                    li.innerHTML = '<span class="page-link">...</span>';
                    paginador.appendChild(li);
                }
            }
        }
        
        for (let i = inicio; i <= fin; i++) {
            paginador.appendChild(crearBoton(i.toString(), i, i === paginaActual, false));
        }

        if (totalPaginas > 5 && fin < totalPaginas) {
            if (fin < totalPaginas - 1) {
                const li = document.createElement('li');
                li.classList.add('page-item', 'disabled');
                li.innerHTML = '<span class="page-link">...</span>';
                paginador.appendChild(li);
            }
            if (fin < totalPaginas) {
                 paginador.appendChild(crearBoton(totalPaginas.toString(), totalPaginas, false, false));
            }
        }
        // ... fin de l√≥gica de botones num√©ricos
        
        paginador.appendChild(crearBoton('Siguiente', paginaActual + 1, false, paginaActual === totalPaginas || totalPaginas === 0));
    }
    
    // Funci√≥n para dibujar los encabezados de la tabla
    function dibujarEncabezados(config) {
        const encabezado = document.getElementById('tablaEncabezado');
        encabezado.innerHTML = '';
        const tr = document.createElement('tr');
        config.encabezados.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            tr.appendChild(th);
        });
        encabezado.appendChild(tr);
    }
    
    // Funci√≥n para rellenar la tabla con los datos del cat√°logo
    function rellenarTabla(registros, config) {
        const cuerpo = document.getElementById('tablaCuerpo');
        cuerpo.innerHTML = '';
        const colSpan = config.encabezados.length;
        
        if (!registros || registros.length === 0) {
            cuerpo.innerHTML = `<tr><td colspan="${colSpan}" class="text-center">No se encontraron registros en este cat√°logo.</td></tr>`;
            return;
        }

        registros.forEach(reg => {
            const tr = document.createElement('tr');
            
            // L√≥gica simple para mostrar las propiedades principales del objeto
            // Esto deber√° ser ajustado manualmente por cada cat√°logo.
            const props = Object.keys(reg).filter(k => k !== 'actions');
            
            props.forEach(prop => {
                const td = document.createElement('td');
                td.textContent = reg[prop];
                tr.appendChild(td);
            });

            // Columna de Acciones
            const tdAcciones = document.createElement('td');
            tdAcciones.innerHTML = `
                <button class="btn btn-sm btn-warning me-2" title="Editar"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
            `;
            tr.appendChild(tdAcciones);
            
            cuerpo.appendChild(tr);
        });
    }

    // Funci√≥n principal de carga de datos para cualquier cat√°logo
    async function cargarDatos(pagina = 1) {
        paginaActual = pagina;
        const config = catalogosConfig[catalogoActual];
        const cuerpo = document.getElementById('tablaCuerpo');
        const info = document.getElementById('infoPaginacion');
        const colSpan = config.encabezados.length;
        cuerpo.innerHTML = `<tr><td colspan="${colSpan}" class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Cargando...</td></tr>`;
        
        dibujarEncabezados(config);
        document.getElementById('tituloTabla').textContent = `Cat√°logo de ${config.titulo}`;
        
        try {
            const url = `../api/index.php?ruta=catalogos/${config.apiEndpoint}&limite=${LIMITE_REGISTROS}&pagina=${pagina}`;
            
            const r = await fetch(url, { credentials:'include' });
            if (!r.ok) throw new Error(`Error API: ${r.statusText}`);
            const data = await r.json();
            
            if (data.ok && data.registros) {
                rellenarTabla(data.registros, config);
                generarPaginador(data.total_paginas, data.pagina_actual);
                
                const inicioReg = (data.pagina_actual - 1) * LIMITE_REGISTROS + 1;
                const finReg = Math.min(data.pagina_actual * LIMITE_REGISTROS, data.total_registros);
                info.textContent = `Mostrando ${inicioReg}‚Äì${finReg} de ${data.total_registros} registros`;
            } else {
                rellenarTabla([], config);
                generarPaginador(0, 1);
                info.textContent = 'No se encontraron datos.';
                mostrarToast(data.error || `Error al cargar ${config.titulo}`, 'error');
            }
        } catch (e) {
            console.error(e);
            rellenarTabla([], config);
            generarPaginador(0, 1);
            info.textContent = 'Error de conexi√≥n con el servidor.';
            mostrarToast('Error al cargar el cat√°logo.','error');
        }
    }
    
    // --- Inicializaci√≥n y Eventos ---
    
    document.getElementById('selectCatalogo').onchange = (e) => {
        catalogoActual = e.target.value;
        cargarDatos(1); // Siempre volvemos a la p√°gina 1 al cambiar de cat√°logo
    };

    // Carga inicial (Cat√°logo 'puntos')
    cargarDatos(1);
    
    // Asumiendo que el bot√≥n "Nuevo" abre un modal o redirige
    document.getElementById('btnNuevoRegistro').onclick = () => {
        mostrarToast(`Acci√≥n: Abrir formulario para Nuevo ${catalogosConfig[catalogoActual].titulo}`,'info');
        // Implementar l√≥gica de modal o redirecci√≥n aqu√≠...
    };
    
    </script>
</body>
</html>