<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>VADUM - Incentivos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="./assets/css/estilos.css">
</head>
<body>
  <div class="contenedor-app d-flex">
    <!-- Sidebar -->
    <nav class="sidebar p-3 d-none d-md-flex flex-column bg-dark" id="sidebarMenu">
      <div class="header-logo text-center mb-4">
        <img src="./assets/img/VADUM-blanco.png" alt="Logotipo VADUM" class="sidebar-logo">
      </div>
      <div class="d-flex flex-column nav-links-sidebar" id="menuLateral">
        <a class="menu-link" id="nav-inicio" href="./index.html" data-roles="admin,supervisor,vigilante,cliente"><i class="material-icons-outlined">home</i> <span>Inicio</span></a>
        <a class="menu-link" id="nav-empleados" href="./empleados.html" data-roles="admin,supervisor"><i class="material-icons-outlined">badge</i> <span>Empleados</span></a>
        <a class="menu-link" id="nav-fisica" href="./captura_fisica.html" data-roles="admin,supervisor"><i class="material-icons-outlined">insights</i> <span>Física</span></a>
        <a class="menu-link" id="nav-mensual" href="./evaluacion_mensual.html" data-roles="admin,supervisor"><i class="material-icons-outlined">rule</i> <span>Mensual</span></a>
        <a class="menu-link" id="nav-encuesta" href="./encuesta.html" data-roles="admin,cliente,supervisor"><i class="material-icons-outlined">question_answer</i> <span>Encuesta</span></a>
        <a class="menu-link activo" id="nav-incentivo" href="./incentivo.html" data-roles="admin,supervisor,vigilante"><i class="material-icons-outlined">payments</i> <span>Incentivo</span></a>
        <a class="menu-link" id="nav-cursos" href="./cursos.html" data-roles="admin,supervisor"><i class="material-icons-outlined">school</i> <span>Cursos</span></a>
        <a class="menu-link" id="nav-faltas" href="./faltas.html" data-roles="admin,supervisor"><i class="material-icons-outlined">event_busy</i> <span>Faltas</span></a>
        <a class="menu-link" id="nav-actas" href="./actas.html" data-roles="admin,supervisor"><i class="material-icons-outlined">description</i> <span>Actas</span></a>
        <a class="menu-link" id="nav-catalogos" href="./catalogos.html" data-roles="admin,supervisor"><i class="material-icons-outlined">settings</i> <span>Catálogos</span></a>
      </div>
    </nav>

    <!-- Main -->
    <div class="main-content-wrapper flex-grow-1 d-flex flex-column">
      <!-- Topbar -->
      <div class="top-navbar sticky-top d-flex justify-content-between align-items-center p-2 bg-white border-bottom shadow-sm">
        <div class="d-flex align-items-center">
          <button class="btn btn-outline-secondary d-md-none me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuOffcanvas" aria-controls="menuOffcanvas"><i class="fas fa-bars"></i></button>
          <span class="fw-bold fs-5 text-dark">Incentivos</span>
        </div>
        <div class="d-flex align-items-center">
          <div class="dropdown me-2">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fas fa-user-circle me-1"></i> <span id="nombreUsuario">Usuario</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton1">
              <li><a class="dropdown-item" href="#">Mi Perfil</a></li>
              <li><a class="dropdown-item" href="#">Configuración</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="#" id="btnCerrarSesionTop">Cerrar Sesión</a></li>
            </ul>
          </div>
          <button class="btn btn-sm btn-danger ms-2" id="btnCerrarSesionTop"><i class="fas fa-sign-out-alt"></i></button>
        </div>
      </div>

      <!-- Content -->
      <main class="flex-grow-1 p-3 p-md-4">
        <div class="card p-3 p-md-4 shadow-sm mb-3">
          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Mes</label>
              <input class="form-control" id="mes" type="month">
            </div>
            <div class="col-md-3">
              <label class="form-label">Buscar</label>
              <input class="form-control" id="bus" placeholder="No.Emp o Nombre">
            </div>
            <div class="col-md-3">
              <button class="btn btn-primary" id="btnCalcular">Calcular</button>
              <button class="btn btn-outline-secondary ms-2" id="btnExportCsv">Exportar CSV</button>
            </div>
            <div class="col-md-3 text-end">
              <div class="small text-muted">Incentivo total por persona: $3,000</div>
            </div>
          </div>
        </div>

        <div class="card p-0 shadow-sm">
          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle" id="tabla">
              <thead class="table-light">
                <tr>
                  <th>No.Emp</th>
                  <th>Nombre</th>
                  <th>Punto</th>
                  <th>Física</th>
                  <th>Cursos</th>
                  <th>Satisfacción</th>
                  <th>Mensual</th>
                  <th>Faltas</th>
                  <th>Acta</th>
                  <th class="text-end">Total ($)</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr class="table-light">
                  <th colspan="9" class="text-end">Total general ($)</th>
                  <th class="text-end" id="totalGeneral">0.00</th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </main>

      <!-- Offcanvas movil -->
      <div class="offcanvas offcanvas-start bg-dark text-white" tabindex="-1" id="menuOffcanvas" aria-labelledby="menuOffcanvasLabel">
        <div class="offcanvas-header bg-warning">
          <img src="./assets/img/VADUM-negro.png" alt="VADUM" style="height:28px;">
          <h5 class="offcanvas-title text-dark fw-bold" id="menuOffcanvasLabel">Menú VADUM</h5>
          <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body p-0">
          <nav class="d-flex flex-column p-2">
            <a class="menu-link" href="./index.html" data-roles="admin,supervisor,vigilante,cliente"><i class="fas fa-home"></i> <span>Inicio</span></a>
            <a class="menu-link" href="./captura_fisica.html" data-roles="admin,supervisor"><i class="fas fa-chart-line"></i> <span>Física</span></a>
            <a class="menu-link" href="./evaluacion_mensual.html" data-roles="admin,supervisor"><i class="fas fa-users-cog"></i> <span>Evaluación</span></a>
            <a class="menu-link" href="./encuesta.html" data-roles="admin,supervisor,cliente"><i class="fas fa-handshake"></i> <span>Encuesta</span></a>
            <a class="menu-link activo" href="./incentivo.html" data-roles="admin,supervisor,vigilante"><i class="fas fa-dollar-sign"></i> <span>Incentivo</span></a>
            <a class="menu-link" href="./cursos.html" data-roles="admin,supervisor"><i class="fas fa-book-open"></i> <span>Cursos</span></a>
            <a class="menu-link" href="./faltas.html" data-roles="admin,supervisor"><i class="fas fa-calendar-times"></i> <span>Faltas</span></a>
            <a class="menu-link" href="./actas.html" data-roles="admin,supervisor"><i class="fas fa-file-alt"></i> <span>Actas</span></a>
            <a class="menu-link" href="./catalogos.html" data-roles="admin,supervisor"><i class="fas fa-cogs"></i> <span>Catálogos</span></a>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="./assets/js/ui.js"></script>
  <script src="./assets/js/auth.js"></script>
  <script>
  (async ()=>{
    const toast = (m)=> (window.VADUM_UI?.mostrarToast? VADUM_UI.mostrarToast(m): alert(m));
    const clean = (t)=> (t||'').replace(/^\uFEFF|^\u200B|^\ufeff/, '');
    async function apiGet(ruta, params={}){
      const qs = new URLSearchParams(params).toString();
      const r = await fetch(`../api/index.php?ruta=${encodeURIComponent(ruta)}${qs?`&${qs}`:''}`, {credentials:'include'});
      const t = await r.text(); const j = t? JSON.parse(clean(t)) : {};
      if (!r.ok || j.ok===false) throw new Error(j.error||`Error ${r.status}`);
      return j;
    }

    const mesInput = document.getElementById('mes');
    const hoy = new Date();
    mesInput.value = `${hoy.getFullYear()}-${String(hoy.getMonth()+1).padStart(2,'0')}`;
    document.getElementById('btnCalcular').addEventListener('click', cargarIncentivos);
    document.getElementById('btnExportCsv').addEventListener('click', exportarCsv);

    let ultimoListado = [];
    async function cargarIncentivos(){
      const tbody = document.querySelector('#tabla tbody');
      tbody.innerHTML = `<tr><td colspan="10" class="text-center py-4">Cargando...</td></tr>`;
      const y = mesInput.value.split('-')[0];
      const m = mesInput.value.split('-')[1];
      if (!y || !m){ toast('Selecciona un mes'); return; }
      const mesDia1 = `${y}-${m}-01`;
      try{
        const { empleados } = await apiGet('empleados/lista', { estado:'ACTIVO' });
        const filtro = (document.getElementById('bus').value||'').trim().toLowerCase();
        const vigilantes = (empleados||[])
          .filter(e=> (e.puesto||'').toLowerCase().includes('vigil'))
          .filter(e=> !filtro || (e.no_emp||'').toString().includes(filtro) || (e.nombre||'').toLowerCase().includes(filtro));

        const filas = [];
        let totalGeneral = 0;
        ultimoListado = [];
        for (const emp of vigilantes){
          try {
            const r = await apiGet('incentivo/calcular', { no_emp: emp.no_emp, mes: mesDia1 });
            const comp = r.totales?.componentes || {};
            const fis = comp.fisico || {}; const cur = comp.cursos || {}; const sat = comp.satisfaccion || {}; const des = comp.desempeno || {}; const ali = comp.alimentacion || {};
            const total = (r.totales?.total_pesos ?? 0).toFixed(2);
            const faltas = ali.faltas ?? 0;
            const motivo = (r.motivo || r.notas?.motivo || '').toString().toLowerCase();
            const acta = (!r.elegible && motivo.includes('acta')) ? 'Si­' : (r.elegible ? 'No' : '');
            totalGeneral += Number(total);
            ultimoListado.push({
              no_emp: emp.no_emp,
              nombre: emp.nombre||'',
              punto: emp.punto_nombre||'',
              fisica: fis.cal ?? '',
              cursos: cur.cal ?? '',
              satisfaccion: sat.cal ?? '',
              mensual: des.cal ?? '',
              faltas: faltas,
              acta: acta,
              total: Number(total)
            });
            filas.push(`<tr>
              <td>${emp.no_emp}</td>
              <td>${emp.nombre||''}</td>
              <td>${emp.punto_nombre||''}</td>
              <td>${fis.cal ?? ''}</td>
              <td>${cur.cal ?? ''}</td>
              <td>${sat.cal ?? ''}</td>
              <td>${des.cal ?? ''}</td>
              <td>${faltas}</td>
              <td>${acta}</td>
              <td class="text-end">${total}</td>
            </tr>`);
          } catch (e) {
            filas.push(`<tr>
              <td>${emp.no_emp}</td>
              <td>${emp.nombre||''}</td>
              <td>${emp.punto_nombre||''}</td>
              <td colspan="6" class="text-muted">No calculable</td>
              <td class="text-end">0.00</td>
            </tr>`);
          }
        }
        tbody.innerHTML = filas.length? filas.join('') : '<tr><td colspan="10" class="text-center">Sin resultados</td></tr>';
        const tg = document.getElementById('totalGeneral'); if (tg) tg.textContent = totalGeneral.toFixed(2);
      }catch(e){ console.error(e); toast(e.message||'No fue posible cargar incentivos'); }
    }

    function exportarCsv(){
      if (!ultimoListado || !ultimoListado.length){ toast('No hay datos para exportar'); return; }
      const encabezados = ['No.Emp','Nombre','Punto','Física','Cursos','Satisfacción','Mensual','Faltas','Acta','Total'];
      const filas = ultimoListado.map(x=>[
        x.no_emp,
        (x.nombre||'').replaceAll(',',' '),
        (x.punto||'').replaceAll(',',' '),
        x.fisica ?? '',
        x.cursos ?? '',
        x.satisfaccion ?? '',
        x.mensual ?? '',
        x.faltas ?? '',
        x.acta ?? '',
        x.total?.toFixed? x.total.toFixed(2) : x.total
      ]);
      const lineas = [encabezados].concat(filas).map(arr=>arr.join(',')).join('\n');
      const blob = new Blob([lineas], {type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const hoy = new Date();
      a.href = url; a.download = `incentivos_${hoy.getFullYear()}-${String(hoy.getMonth()+1).padStart(2,'0')}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // carga inicial
    await cargarIncentivos();
  })();
  </script>
</body>
</html>



