<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>VADUM Â· EvaluaciÃ³n Mensual</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="./assets/css/estilos.css">
</head>
<body>
    <!-- ====== Header Superior (logo, nombre, perfil/login) ====== -->
    <header class="header-superior">
      <nav class="nav-sup">
        <a class="nav-sup__logo" href="./index.html">
          <img src="./assets/img/VADUM-negro.png" alt="VADUM">
          <span class="nav-sup__titulo">Sistema Automatizado de Incentivos Â· VADUM</span>
        </a>
        <div class="nav-sup__espaciador"></div>

        <!-- MenÃº de perfil -->
        <div class="perfil" id="perfilMenu">
          <button class="perfil__btn" id="btnPerfil">
            <span id="usuarioActual">â€¦</span>
            <span class="perfil__avatar">ðŸ‘¤</span>
          </button>
          <div class="perfil__dropdown" id="perfilDropdown">
            <div class="perfil__info">
              <div class="perfil__nombre" id="perfilNombre">Usuario</div>
              <div class="perfil__rol" id="perfilRol">Rol</div>
            </div>
            <a class="perfil__item" href="#" id="irPerfil">Mi perfil</a>
            <button class="perfil__item perfil__salir" id="btnSalir">Cerrar sesiÃ³n</button>
          </div>
        </div>
      </nav>
    </header>

    <!-- ====== Header Inferior (botones de navegaciÃ³n) ====== -->
    <div class="header-inferior" id="barraNavegacion">
      <nav class="nav-inf">
        <!-- Muestra/oculta por rol con data-roles -->
        <a class="nav-btn" id="nav-inicio" href="./index.html" data-roles="admin,supervisor,vigilante,cliente">Inicio</a>
        <a class="nav-btn" id="nav-empleados" href="./empleados.html" data-roles="admin,supervisor">Empleados</a>
        <a class="nav-btn" id="nav-fisica" href="./captura_fisica.html" data-roles="admin,supervisor">FÃ­sica</a>
        <a class="nav-btn" id="nav-mensual" href="./evaluacion_mensual.html" data-roles="admin,supervisor">Mensual</a>
        <a class="nav-btn" id="nav-encuesta" href="./encuesta.html" data-roles="admin,cliente,supervisor">Encuesta</a>
        <a class="nav-btn" id="nav-incentivo" href="./incentivo.html" data-roles="admin,supervisor,vigilante">Incentivo</a>
      </nav>
    </div>

    <script>
    // Marca activo segÃºn archivo
    const mapaActivos = {
      'index.html':'nav-inicio',
      'empleados.html':'nav-empleados',
      'captura_fisica.html':'nav-fisica',
      'evaluacion_mensual.html':'nav-mensual',
      'encuesta.html':'nav-encuesta',
      'incentivo.html':'nav-incentivo'
    };
    const actual = location.pathname.split('/').pop();
    const idAct = mapaActivos[actual];
    if (idAct) document.getElementById(idAct)?.classList.add('nav-btn--activo');
    </script>



  <main class="contenedor">
    <section class="tarjeta">
      <h1 class="titulo">EvaluaciÃ³n Mensual</h1>
      <div class="fila fila--3">
        <div><label class="label">No.Emp</label><input class="input" id="no_emp" value="950001"></div>
        <div><label class="label">Mes (dÃ­a 1)</label><input class="input" id="mes" type="date" value="2025-09-01"></div>
        <div><label class="label">Supervisor ID</label><input class="input" id="sup" value="sup-001"></div>
      </div>
      <div class="fila fila--4" style="margin-top:12px; grid-template-columns: repeat(4,1fr);">
        <div><label class="label">Puntualidad (1-5)</label><input class="input" id="p" type="number" min="1" max="5" value="5"></div>
        <div><label class="label">Disciplina (1-5)</label><input class="input" id="d" type="number" min="1" max="5" value="4"></div>
        <div><label class="label">Imagen (1-5)</label><input class="input" id="i" type="number" min="1" max="5" value="4"></div>
        <div><label class="label">DesempeÃ±o (1-5)</label><input class="input" id="x" type="number" min="1" max="5" value="5"></div>
      </div>
      <div style="margin-top:12px;"><button class="btn" id="guardar">Guardar evaluaciÃ³n</button></div>
    </section>

    <section class="tarjeta" style="margin-top:16px;">
      <h2 class="subtitulo">Firmas</h2>
      <div class="fila fila--2">
        <div>
          <p class="label">Firma empleado</p>
          <canvas id="firmaEmp" width="320" height="120" style="background:#fff; border:1px dashed #777; border-radius:8px;"></canvas><br>
          <button class="btn" id="guardarEmp">Guardar firma empleado</button>
        </div>
        <div>
          <p class="label">Firma evaluador</p>
          <canvas id="firmaEval" width="320" height="120" style="background:#fff; border:1px dashed #777; border-radius:8px;"></canvas><br>
          <button class="btn" id="guardarEval">Guardar firma evaluador</button>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">Â© VADUM Â· AutomatizaciÃ³n de Incentivos Â·</footer>
  <script src="./assets/js/ui.js"></script>
  <script src="./assets/js/auth.js"></script>
  <script>
    async function post(url, data){
      const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data) });
      return r.json();
    }
    const dibujar = (canvas)=>{
      const ctx = canvas.getContext('2d'); let pintando=false;
      canvas.addEventListener('mousedown',()=>pintando=true);
      canvas.addEventListener('mouseup',()=>pintando=false);
      canvas.addEventListener('mousemove',(e)=>{
        if(!pintando) return; const r=canvas.getBoundingClientRect();
        ctx.fillStyle='#000'; ctx.beginPath();
        ctx.arc(e.clientX-r.left,e.clientY-r.top,1.2,0,Math.PI*2); ctx.fill();
      });
    };
    dibujar(document.getElementById('firmaEmp'));
    dibujar(document.getElementById('firmaEval'));

    document.getElementById('guardar').onclick = async ()=>{
      const datos = {
        no_emp: document.getElementById('no_emp').value.trim(),
        mes:    document.getElementById('mes').value,
        puntualidad:+document.getElementById('p').value,
        disciplina:+document.getElementById('d').value,
        imagen:+document.getElementById('i').value,
        desempeno:+document.getElementById('x').value,
        supervisor_id: document.getElementById('sup').value.trim()
      };
      const r = await post('../api/index.php?ruta=mensual/guardar', datos);
      mostrarToast(`Guardado â€¢ Promedio ${r.prom_1_5} â†’ ${r.cal_0_100}`);
    };

    document.getElementById('guardarEmp').onclick = async ()=>{
      const no_emp = document.getElementById('no_emp').value.trim();
      const mes    = document.getElementById('mes').value;
      const dataURL = document.getElementById('firmaEmp').toDataURL('image/png');
      const r = await post('../api/index.php?ruta=firmas/guardar', { tipo:'mensual_empleado', no_emp, mes, firma_base64: dataURL });
      mostrarToast('Firma empleado guardada');
    };
    document.getElementById('guardarEval').onclick = async ()=>{
      const no_emp = document.getElementById('no_emp').value.trim();
      const mes    = document.getElementById('mes').value;
      const dataURL = document.getElementById('firmaEval').toDataURL('image/png');
      const r = await post('../api/index.php?ruta=firmas/guardar', { tipo:'mensual_evaluador', no_emp, mes, firma_base64: dataURL });
      mostrarToast('Firma evaluador guardada');
    };
  </script>
</body>
</html>